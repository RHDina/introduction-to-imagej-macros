\usepackage{xltxtra}
\usepackage{amssymb, amsmath, mathtools, amsthm}
\usepackage{fontspec}
\usepackage{xunicode}
\defaultfontfeatures{Mapping=tex-text}
%\setmainfont{Ubuntu} % Main document font
\definecolor{skyblue1}{RGB}{114,159,207}
\definecolor{plum1}{RGB}{173,127,168}
\definecolor{chameleon1}{RGB}{78,154,6}
\definecolor{chocolate1}{RGB}{193,125,17}
\definecolor{comments}{RGB}{78,154,6}
\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mygray}{rgb}{0.5,0.5,0.5}
\definecolor{mymauve}{rgb}{0.58,0,0.82}

\mode<presentation> {
  \usetheme{Pittsburgh}
  \setbeamercolor{normal text}{fg=black!60!white}
  \setbeamercolor{framesubtitle}{fg=black!50!white}
  \setbeamercolor{title}{fg=plum1}
  %\setbeamercolor{block title example}{fg=chocolate1}
  \setbeamercolor{structure}{fg=skyblue1}
  \beamertemplateshadingbackground{black!20!white}{white}
  \usefonttheme{structurebold}
  \beamertemplatenavigationsymbolsempty
  \setbeamertemplate{footline}[frame number]
  \defbeamertemplate*{title page}{customized}[1][] {
    \flushright
    \usebeamerfont{title}\usebeamercolor[fg]{title}\inserttitle\par
    \usebeamerfont{subtitle}\usebeamercolor[fg]{subtitle}\insertsubtitle\par
    \bigskip
    \usebeamerfont{author}\usebeamercolor[fg]{normal text}\insertauthor\par
    \usebeamerfont{institute}\insertinstitute\par
    \usebeamerfont{date}\insertdate\par
    \usebeamercolor[fg]{titlegraphic}\inserttitlegraphic
  }
}


\usepackage{hyperref}

\usepackage{listings}
\lstset{ backgroundcolor=\color{yellow!10!white}, basicstyle=\footnotesize,
  breakatwhitespace=false, breaklines=true,
  captionpos=t, commentstyle=\color{comments},
  deletekeywords={...}, escapeinside={\%*}{*)},
  extendedchars=true, frame=none,
  keepspaces=true, keywordstyle=\color{blue},
  language=Java, otherkeywords={macro,function},
  numbers=none, numbersep=5pt,  numberstyle=\tiny\color{mygray},
  rulecolor=\color{black},  showspaces=false, showstringspaces=false,
  showtabs=false,  stepnumber=2,  stringstyle=\color{mymauve},
  tabsize=2,  title=\lstname, abovecaptionskip=0cm,belowcaptionskip=0cm
}

\only<presentation>{\lstset{basicstyle=\tiny}}

\usepackage{menukeys}

\usepackage{tikz}
\usetikzlibrary{calc,shapes,positioning}

\newcommand{\kw}[1]{\textcolor{orange}{\textbf{#1}}}
\newcommand{\code}[1] {\textcolor{gray}{\texttt{#1}}}
%\newtheorem{example}{Example:}
\setcounter{tocdepth}{1}
\title{Introduction to ImageJ Macros}
\author{Dina Ratsimandresy (rhdina@) \\ Qimeng Wu (qwu@) \\ J\'er\^ome Boulanger (jeromeb@)}
\date{}
\begin{document}
\begin{frame}
  \maketitle
\end{frame}

%\begin{frame}<presentation>
%  \mode<presentation>{\frametitle{Outline}}
%  \tiny \tableofcontents
%\end{frame}

\section{Introduction}
\begin{frame}
  \frametitle<presentation>{Introduction}
  The objectives of this \only<presentation>{lecture}\only<article>{document} is to
  \begin{itemize}
    \item be able to automatize repetitive tasks,
    \item enable more quantitative analysis of microscopy images,
    \item create reproducible workflows,
    \item become more familiar with programming.
  \end{itemize}
  Where to get help?
  \begin{itemize}
    \item \url{http://imagej.nih.gov}
    \item \url{http://fiji.sc}
    \item \url{https://forum.image.sc/}
  \end{itemize}
\end{frame}

You will find a detailed reference on ImageJ built-in macro function
\href{http://rsb.info.nih.gov/ij/developer/macro/functions.html}{here}. In
several places of this document you will find direct entry to sections
of this page.

\begin{frame}
  \frametitle{But why the ImageJ macro language?}
  \begin{itemize}
    \item ImageJ is a widespread tool in the community.
    \item The ImageJ 1 Macro language do not require a full knowledge of the
    underlying ImageJ code (API).
    \item Macro language allows you to go beyond clicking around.
    \item You may decide to continue later to script using Python,
    BeanShell, Clojure or JavaScript to be able to perform more
    advanced scripts.
    \item Even if in the future you don't use ImageJ macro programming
    language you will learn some basic programming techniques.
  \end{itemize}
\end{frame}

\section{Macro Basics}
\subsection{Macro Basics}
\begin{frame}[fragile]
  \frametitle<presentation>{Macro basics}
  \begin{itemize}
    \item A \kw{script} is a set of instruction that can be interpreted
    by the ImageJ macro interpreter (like in Python \& Basic unlike
    C or Java).
    \item A \kw{macro} is a script which has been recorded
    \item It is stored in a text file (.ijm) (not a MS Word document).
    \item A file can contain several macros and define a toolset.
    \item \kw{Instructions} are terminated by a semi colon ``;'' and can
      be grouped inside a pair of curly braces.
    \item Instruction starting with \verb$//$ or between \verb$/* */$
      are \kw{comments} (not interpreted).
    \item To be able to install a macro you need to use the syntax:
      \begin{minipage}{5cm}
        \verb$   macro "name [shortcut]" { instructions; } $
      \end{minipage}
    \item You can discard this syntax for testing quickly pieces of code.
\end{itemize}
\end{frame}

\begin{frame}[fragile]
  \begin{example}[Hello World]~\par
  \begin{itemize}
   \item Create a new macro
  \menu{File > New > Script} or \menu{Plugins > New > Macro} or press \keys{[}) and select \menu{Language > ImageJ Macro}.
  \item Write down the first macro:\par
    \lstinputlisting[firstline=3]{macros/mac1.ijm}
  \item Identify the macro name, the instructions and the curly braces around it.
  \item Test the macro using \keys{Run} or \keys{Ctrl+R}
  \item Save the macro using \menu{File > Save}.
  \item Install it using \menu{Plugins > Macro >
      Install\dots} from the main user interface.
  \end{itemize}
\end{example}
\end{frame}

\begin{frame}
  \frametitle{Macro recorder}
  \begin{itemize}
  \item You can record actions using \menu{Plugins > Macros > Record \dots}.
  \item Let's try to segment an image and measure intensities in the
    regions of interest defined by the mask:
    \begin{enumerate}
    \item Open the sample Zeiss1328.lsm \menu{File > Open > ../Zeiss1328.lsm}
    \item Duplicate the nuclei channel using  \menu{Image > Duplicate}, tick ``Duplicate hyperstack", set ``Channels (c)" to 4 and give the new window a name ``nuclei".
    \item Apply a Gaussian blur of radius 3 to the new image \menu{Process > Filters > Gaussian Blur\dots}.
    \item Threshold this image using the auto-threshold \menu{Image > Adjust > Auto threshold}, choose ``Mean" thresholding method and click ``Apply" to obtain a mask.
    \item Fill the holes \menu{Process > Binary > Fill Holes}.
    \item Apply a watershed to split regions \menu{Process > Binary > Watershed}.
    \item Define region of interests using \menu{Analyze > Analyse Particles\dots}, tick the add to ROI manager box and choose the appropiate size e.g. 3-Infinity.
    \item Close the mask window (nuclei).
    \item Set the measurments in \menu{Analyze > Set Measurements\dots}.
    \item On the ROI Manager select \menu{Measure}.
    \end{enumerate}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle<presentation>{Macro recorder}
  \begin{itemize}
    \item By clicking on \keys{Create} button, we obtain the following
    macro:\par
    \lstinputlisting[firstline=1]{macros/mac2.ijm}
    \item How many instructions are there in the macro?
    \item How can we make this code more general in order to apply it to
      another image?
  \end{itemize}
\end{frame}

\section{Building blocks}
A programming language is defined by its syntax. We describe some
elements of it in this section. ImageJ Macro language is an interpreted
procedural language whose syntax is close to e.g.: C, Java or
JavaScript.
\subsection{Variable \& Operations}
\begin{frame}
  \frametitle<presentation>{Variables \& Operations}
  \begin{block}{Variables}
    \begin{itemize}
    \item A \kw{variable} is a symbolic representation associated to a value.
    \item They can be of several \kw{type}: number, string or boolean.
    \item They have no explicit type (like in Python, unlike C or Java).
    %\item When not first declared in a function they are \kw{global}.
    %\item Use \kw{var} make it persistent once the macro is installed.
    \item A variable is \kw{local} if it is only accessed within the sub-program it has been declared or created within.
    \item A variable is \kw{global} if it is accessed by any sub-program or module.
    \item You can \kw{assign} a value to a variable using operator \code{=}.
    \end{itemize}
  \end{block}\only<presentation>{\vspace{-.3cm}}
   \end{frame}
   
   \begin{frame}
   	\frametitle<presentation>{Variable}
   	\begin{example}[Variable assignement]
   		\begin{itemize}
   			\item Create a new macro with a simple function that can overwrite the value assigned to a variable.\par
   			\lstinputlisting[firstline=1]{macros/mac3.ijm}
   			\item Run the macro and observe the result printed on the log file.
   			\item Now tick the parameter ``REPL" (Read–Eval–Print Loop) and observe the printed result on the log. Which of the two options lead to a global and local variable? 
   			\item We'll keep REPL unticked for the rest of the course.
   		\end{itemize}
   	\end{example}
   \end{frame}
   
   
  \begin{frame}
  	\frametitle<presentation>{Operations}
  \begin{block}{Operations}
    \begin{itemize}
    \item Usual operations on number are valid (\code{+},\code{-},\code{*},\code{/}).
    \item Operation on boolean are the logical ``and'' \code{\&\&} and ``or''  \code{||}.
    \item \kw{Comparison} on variable are the equality \code{==},
      the non-equality \code{!=}, greater and equal than \code{>=}
      lower and equal then \code{<=} and their respective strict
      version \code{>} and \code{<}. Their result is a boolean.
    \end{itemize}
  \end{block}
\end{frame}

 \begin{frame}
   \frametitle<presentation>{Truth tables}
   \begin{center}
    \begin{tabular}{ccccccc}
        &   & not & and & or & xor \\
      A & B & !A &  A \&\& B & A || B & (A||B)\&\& !(A\&\&B) \\ \hline
      0 & 0 & 1  & 0 & 0 & 0 \\
      0 & 1 & 1  & 0 & 1 & 1 \\
      1 & 0 & 0  & 0 & 1 & 1 \\
      1 & 1 & 0  & 1 & 1 & 0 \\
    \end{tabular}
  \end{center}

  \begin{center}
   \begin{tikzpicture}[scale=0.5]

    \begin{scope}[shift={(0,0)}]
     \draw (0,0) circle(1) node {A} ++(1.3,0) circle(1) node {B};
     \begin{scope}
      \clip (0,0) circle(1);
      \draw[black,fill=orange] (1.3,0) circle(1);
     \end{scope}
     \node at (0.9,-1.5) {and};
    \end{scope}

    \begin{scope}[shift={(5,0)}]
      \draw[black,fill=orange] (0,0) circle(1) node[white,shift={(-0.07,0)}] {A} ++(1.3,0) circle(1) node[white,shift={(+0.07,0)}] {B};
      \node at (0.9,-1.5) {or};
    \end{scope}

    \begin{scope}[shift={(10,0)}]
      \fill[even odd rule,orange] (0,0) circle (1) ++(1.3,0) circle (1);
      \draw[black] (0,0) circle(1) node[white,shift={(-0.07,0)}]  {A} ++(1.3,0) circle(1) node[white,shift={(0.07,0)}]  {B};
      \node at (0.9,-1.5) {xor};
    \end{scope}

   \end{tikzpicture}
  \end{center}

  \begin{itemize}
    \item !(A \&\& B) = !A || ! B
    \item !(A || B) = !A \&\& !B
  \end{itemize}

 \end{frame}

\begin{frame}
  \frametitle<presentation>{Operations}
  \begin{example}[Operations on number \& boolean]~\par
    \lstinputlisting[firstline=3]{macros/mac4.ijm}
  \end{example}
\end{frame}

\subsection{Conditional Branching}
\begin{frame}[fragile]
  \frametitle<presentation>{Conditional branching}
  \begin{itemize}
  \item A \kw{condition} is a boolean and a section of code
    can be interpreted or not depending on whether it is
    \textcolor{blue}{true} or \textcolor{blue}{false}.
  \item The syntax is
\begin{verbatim}
if (conditionA) {
  instructionA;
} else if (conditionB) {
  instructionB;
} else {
  instructionC;
}
\end{verbatim}
  \end{itemize}
\end{frame}

\begin{frame}
  \begin{example}[Conditional branching]~\par

    \lstinputlisting[firstline=3]{macros/mac5.ijm}
  \end{example}
\end{frame}

\subsection{Loops}
\begin{frame}[fragile]
  \frametitle<presentation>{Loops}
  \begin{itemize}
  \item There are 3 sort of \kw{loops}:
    \begin{enumerate}
    \item the \kw{for} loop:
      \begin{verbatim}
for (initialization; condition; increment) {
   instruction;
}
    \end{verbatim}
    \item the \kw{while} loop:
      \begin{verbatim}
while (condition) {
   instruction;
}
    \end{verbatim}
    \item the \kw{do-while} loop:
      \begin{verbatim}
do {
   instruction;
} while (condition);
    \end{verbatim}
    \end{enumerate}
  \item The syntax \code{i++;} is equivalent to \code{i = i + 1;}
  \end{itemize}
\end{frame}

\begin{frame}
  \begin{example}[Loops]~\par
    \lstinputlisting[firstline=3]{macros/mac6.ijm}
  \end{example}
\end{frame}

\begin{frame}[fragile]
	\frametitle<presentation>{Best practices}
	\begin{itemize}
		\item<1-> Code does not need to look pretty to be
		functional and this code can be executed:\par
		\lstinputlisting[firstline=3]{macros/mac_game.ijm}
		\item<2-> To improve reproducibility, reusability and robustness:
		\begin{itemize}
			\item document the code using  \textcolor{green!50!black}{/*comments*/} and  \textcolor{green!50!black}{//}
			\item adapt a consistent formatting
			\item split the code into reusable blocks.
			\item include tests on small blocks (unit test) and end to end tests.
			\item think of a way to share the code and licencing
		\end{itemize}
		\item<3-> Exercise: use these knowledge to improve the readibity of the mac\_game script. \\ \kw{Hint}: an instruction always terminates with a semi-colon (\kw{;}).
	\end{itemize}
\end{frame}

\subsection{Arrays}
\begin{frame}[fragile]
  \frametitle<presentation>{Arrays}
  \begin{itemize}
  \item Arrays are list of values stored in a single variable,
    \begin{center}
      \begin{tikzpicture}[minimum size=.75cm, draw]
        \node[shape=circle,draw] (A) at (-1,0) {A};
        \node[shape=rectangle,draw] (a0) at (0,0) {132};
        \node[red!70!black,below of = a0,node distance=.75cm,draw] (i0) {\small 0};
        \draw (A) -- (a0);
        \node[shape=rectangle,draw, right of = a0] (a1) {13};
        \node[red!70!black,below of = a1,node distance=.75cm,draw] (i1) {\small 1};
        \draw (a0) -- (a1);
        \node[shape=rectangle,draw, right of = a1] (a2) {17};
        \node[red!70!black,below of = a2,node distance=.75cm,draw] (i2) {\small 2};
        \draw (a1) -- (a2);
        \node[shape=rectangle,draw, right of = a2] (a3) {36};
        \node[red!70!black,below of = a3,node distance=.75cm,draw] (i3) {\small 3};
        \draw (a2) -- (a3);
        \node[gray, right of = a3, node distance=1.5cm] (c1) {value};
        \draw[gray,->] (c1) -- (a3);
        \node[gray, right of = i3, node distance=1.5cm] (c2) {index};
        \draw[gray,->] (c2) -- (i3);
      \end{tikzpicture}
    \end{center}
  \item created using the syntax \code{a = newArray(size);}
  \item indexed with a integer running from \code{0} to \code{a.length-1}.
  \item calling \code{a[i]} return the value stored at index \code{i}.
  \item initialize an array with values using
    \begin{center}
      \code{a = newArray(value1, value2, value3);}
    \end{center}
  \item concatenate two arrays using:
    \begin{center}
      \code{array3 = Array.concat(array1, array2);}
    \end{center}
  \item print the values using \code{Array.print(a);}
  \item copy the values \code{a = Array.copy(a);}
  \item sort the values of the array \code{Array.sort(a);}
  \end{itemize}
\end{frame}

\begin{frame}
  \begin{example}[Loops \& arrays]~\par
    \begin{itemize}
    \item  In this example, we use a loop to store the square of number in an array:
      \lstinputlisting[firstline=3]{macros/mac7.ijm}
    \item Create a macro to sort a list of randomly generated numbers.
    \end{itemize}
  \end{example}
\end{frame}

\subsection{Functions}
\begin{frame}[fragile]
  \frametitle<presentation>{Functions}
  \begin{itemize}
  \item \kw{Functions} are a set of commands with optionally some
    \kw{input parameters} and a \kw{return value}.
  \item Lots of function are already declared (eg example \code{print()})
  \item Mathematical functions (\code{sqrt()}, \code{exp()}, \code{log()}, \code{sin()}, \dots) are avaiblable on numbers.
  \item The syntax to declare your \kw{own} functions is the following:
\begin{verbatim}
function functionName (parameters1, parameter2) {
  instructions;
  return output;
}
\end{verbatim}
  \item Integer, strings and boolean are passed by value and arrays are passed by reference.
  \item Function can not be called from another file
    except the one located in \code{ImageJ/macros/Library.txt}.
  \end{itemize}
\end{frame}

\begin{frame}
  \begin{example}[Function]~\par
    Let's code a function that add 1 to a number and another function that add 1
    to each elements of an array: \par
    \lstinputlisting[firstline=3]{macros/mac8.ijm}
  \end{example}
\end{frame}

\begin{frame}
  \begin{example}[Median value]~\par
    \begin{itemize}
    \item Let's now define a function computing the median value of an array.\par
      \lstinputlisting[firstline=3,lastline=12]{macros/mac9.ijm}
    \item Write an example to test this function on an array of random numbers.
    \end{itemize}

  \end{example}
\end{frame}

\begin{frame}
  \begin{example}[Median of pixel values]~\par
    \begin{itemize}
    \item In this example, we define a function going through the pixel
      values of the image and fill an array.
    \item An array is 1D (one index) while the image has at least 2D
      (two indices), we then have to unroll the pixels in 1D.
      \lstinputlisting[firstline=3,lastline=12]{macros/mac10.ijm}
    \item We can note already the two functions \code{getHeight} and
      \code{getWidth} used to get the image dimensions as well as the
      function \code{getPixel(x, y)} to read the pixel value.
    \item Combine the two last examples to compute the median value of
      the pixel of the nuclei channel in the Zeiss1328.lsm image.
    \end{itemize}
  \end{example}
\end{frame}

\section{ROI Manager}
Reference information on ROI is located
\href{http://rsb.info.nih.gov/ij/developer/macro/functions.html#Roi}{here}.
\begin{frame}[fragile]
	\frametitle<presentation>{ROI manager}
	\begin{itemize}
		\item You can interact with the ROI Manager using the function
		\code{roiManager(cmd);} where \code{cmd} can be "Add", "Add \&
		Draw", "Update", "Delete", "Deselect", "Measure", "Draw", "Fill",
		"Label", "Combine", "Split", "Sort", "Reset", "Multi Measure",
		"AND", "OR", "Multi Plot", "Show All", "Show None", "Show all with
		labels", "Show all without labels" or "Remove Slice Info".
		\item The ROI manager runs faster in batch mode. In a macro start
		by closing the Roi Manager:
		\lstinputlisting[firstline=3]{macros/mac24.ijm}
	\end{itemize}
\end{frame}

\begin{frame}[fragile]
	\frametitle<presentation>{ROI selection}
	\begin{itemize}
		\item The number of ROI is given by \code{N = roiManager("count");}
		\item the index of the current ROI is given by \code{index = roiManager("index");}
		\item you can select several ROI using \code{roiManager("select", indices);} where indices is an array.
		\item Indices are between 0 and N-1.
		\item A good idea for function creating ROIs is to return an array of the ROIs.
		\item For example to loop over the ROI and print their type, we
		can use the following macro:\par
		\lstinputlisting[firstline=3]{macros/mac25.ijm}
	\end{itemize}
\end{frame}


\begin{frame}[fragile]
	\frametitle<presentation>{ROI Measures}
	\begin{itemize}
		\item Once ROI are defined we can measure quantities such as mean, min, max, centroid position etc.
		\item To get the name of the possible measurement make a small test ticking the desired measurements in the \menu{Analyze > Set Measurements} dialog.
		\item Using a macro, you can define quantities for the ROIs that are not
		available from the standard measurement.
		\item You can use \code{getValue()} to access measurements using the names
		of the columns of the measurement table.
	\end{itemize}
\end{frame}

\begin{frame}[fragile]
	\begin{example}[Measurements]~\par
		\begin{itemize}
			\item We will use the nuclei ROIs of the Zeiss1328.lsm we had before in this exercise. Re-segment the nuclei if the roimanager is now closed.
			\item Use the following macro to measure the centroid of the ROIs:\par
			\lstinputlisting[firstline=3]{macros/mac26.ijm}
			\item Add some more measurements to the table by editing the macro.
			\item How can you change the code to add the measurement of the mean intensity per nuclei in each channel? (\kw{Hint:} Use \kw{nSlices} to count the number of channels.)
		\end{itemize}
	\end{example}
\end{frame}

\begin{frame}[fragile]
	\begin{example}[Measurement table]~\par
		\begin{itemize}
			\item It is important to manually check back the result to ensure the measurement is done on the right channel and on the right ROI.
			\item The result default table is named ``Results" and a measurement will be by default appended into this table or overwrites the existing result on it.
			\item Avoid this by create a new table for a given measurement:\par
			\lstinputlisting[firstline=1]{macros/mac26_update.ijm}
		\end{itemize}
	\end{example}
\end{frame}

\begin{frame}[fragile]
	\begin{example}[Measurement table]~\par
		\begin{itemize}
			\item Check the result in the new table.
			\item Change the code to add the ROI label into the table.
			\item Convert the code into a function that takes as input the name of the file on which the measurement is done and the name of the table.
			\item Add the file name into the table inside of the function.
		\end{itemize}
	\end{example}
\end{frame}

%\begin{frame}[fragile]
%	\begin{example}[Extra exercise with plugin installation]~\par
%		The Zeiss1328.lsm is a data with four channels with Ch1: Golgi marker GM130, Ch2: cargo protein, Ch3: mitochondria and Ch4: nuclei marked with DAPI. It was acquired for an experiment that consists of measuring the colocalization between a cargo protein and a Golgi marker and the cargo protein. \vspace{0.15cm}
%		
%		To do this measurement, one first needs to:
%		\begin{itemize}
%			\item Segment the cell regions using either Ch1 or Ch2.
%			\item If a simple thresholding or watershed is not working, a marker-controlled watershed segmentation is required using the nuclei ROIs as markers.
%			\item An installation of an appropriate plugin will be required: \menu{Help > Update > Manage Update Sites}. We will need the plugin \kw{''MorphoLibJ"} which is in the ''IJPB-plugins".
%			\item Segment the cell using the marker-controlled watershed segmentation in ''MorphoLibJ".
%		\end{itemize}
%	\end{example}
%\end{frame}

%\section{Day separator}
%\begin{frame}[fragile]
%	\kw{End of Day 1.}
%\end{frame}
%
%\begin{frame}[fragile]
%	\kw{Day 2.}
%	\begin{itemize}
%		\item String and path name manipulations
%		\item User interaction
%		\item Images \& Windows
%		\item Batch processing
%		\item Calling another macro
%		\item Overlays
%		\item Saving the results
%	\end{itemize}
%\end{frame}

\section{Strings}

Strings are useful for manipulating file names, titles of windows and printing
informative messages.

\subsection{Definition}
\begin{frame}[fragile]
  \frametitle<presentation>{String}
  \begin{itemize}
  \item A \kw{string} is a sequence of characters it can be a
    filename, a window name, a message on log window, metadata.
  \item Defined by \kw{double quotes}: \code{str = "i am a string"}.
  \item The length of a string is given by \code{lengthOf(string);}
  \item Concatenatenation is done using the operator \code{+} (cf previous example).
    \begin{itemize}
    \item Note that \code{str = 1+" this is a string";} produces an error.
    \item It is necessary to start using an empty string: \code{str = ""+1+" this is a string";}
    \end{itemize}
  \end{itemize}
\end{frame}

\subsection{Formating \& Printing}

Several functions are useful for formating strings.

\begin{frame}[fragile]
  \frametitle<presentation>{Formating}
  \begin{itemize}
  \item \code{d2s(number, decimals)} converts a real to a string.
  \item \code{IJ.pad(number, size);} convert an integer to a string with zero-padding.
  \item The function \code{print(string);} prints the string in the log window.
  \item The function \code{print("\textbackslash\textbackslash Clear");} clears the log window.
  \item The special character \code{"\textbackslash n"} defines a carriage return (line break).
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \begin{example}[String formating]~\par
    \begin{itemize}
    \item In this example we experiment with the different formating
      functions.~\par
      \lstinputlisting[firstline=3]{macros/mac11.ijm}
    \end{itemize}
  \end{example}
\end{frame}

\subsection{Operations}

Operation on strings enable to append, extract and test the content of strings.

\begin{frame}
  \frametitle<presentation>{String manipulation}
  \begin{itemize}
    \item Concatenate two string to each other using the \code{+} operator.
    \item Extract a substring using \code{substring(string, index1,
        index2)}. The indices are between \code{0} and
      \code{lengthOf(string)} and the resulting string is between
      \code{index1} and \code{index2-1}.
    \item \code{indexOf(string, substring)} and
      \code{lastIndexOf(string, substring)} return the index where the
      substring appears first and respectively last in the string.
    \item \code{startsWith(string, prefix)} and \code{endsWith(string,
        suffix)} test if a string starts / ends with the given prefix or
      suffix.
    \item To list the files in a directory you can use the function
      \code{list = getFileList(myDir);} which return an array of
      filenames (strings) located in the folder myDir. It is then
      possible to loop over the items in the array.
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
	\begin{example}[Working with strings]~\par
		In this example, we firstly want to get familiar with string manipulation and filenames.
		\begin{itemize}
			\item Choose a filename with a given extension as simple or as complex as you want or choose the name of one of the files in the data folder and attribute it to a variable named ``filename".
			\begin{itemize}
				\item Test the function \code{lengthOf} on the filename of your choice.
				\item Use \code{lastIndexOf} to determine where the extension starts in the string and use \code{substring} to get the file extension and the base name of the file of your interest.
				\item Now test the function \code{endsWith} whether another filename is with the same extension or not
			\end{itemize}
			\item Attribute the directory of the data folder to a variable ``myDir"
			\item Use \code{getFileList} to list all the files you have in this folder and use \code{Array.print} to print them on the log window.
			\item Write a loop function that goes through each of the listed file and print the file name if it is NOT ending with ``.lsm".
		\end{itemize}
	\end{example}
\end{frame}


\begin{frame}[fragile]
  \begin{example}[Append to filename]~\par
    \begin{itemize}
    \item Now let's assume we have processed one file and we want to save the file with a name that still has the filename but with another string to indicate this change.
    \item We will write a function that can append a string after the filename and before the extension of the filename.~\par
      \lstinputlisting[firstline=3,lastline=14]{macros/mac12.ijm}
      \item How can we change this code to generate a file name with a different extension such as a csv?
    \end{itemize}
  \end{example}
\end{frame}

\begin{frame}[fragile]
  \begin{example}[Path name manipulation]~\par
    \begin{itemize}
    \item Let's define two functions returning the basename and the
      dirname of a path (see File.getName(path)).~\par
      \lstinputlisting[firstline=3,lastline=14]{macros/mac13.ijm}
    \end{itemize}
  \end{example}
\end{frame}

\subsection{Regular expressions}
\begin{frame}[fragile]
  \frametitle<presentation>{Regular expressions}
  \begin{itemize}
  \item  A \kw{regular
      expression} describes a pattern.
    \begin{itemize}
    \item \verb?^? matches the start
    \item \$ the end
    \item . any characters
    \item * any number of time
    \item the brackets [~] allows to specify a range of characters eg:
      [0-9] are numbers [a-zA-Z] letters.
    \end{itemize}
  \item To match the characters \verb?^?, \$, ., [, ] and * you need to
    ``escape'' them using a backslash \verb?\?.
  \item \code{matches(string, regex)} returns \textcolor{blue}{true}
    if the string matches the regular expression.
  \item \code{replace(string, old, new)} allows to replace the string
    \code{old} by \code{new} in the string. Again regular expression
    can be used.
  \end{itemize}
\end{frame}

\begin{frame}
  \begin{example}[String filtering]~\par
    \begin{itemize}
    \item In this example, we define a function to keep only elements
      in an array matching a certain pattern.\par
      \lstinputlisting[firstline=3,lastline=13]{macros/mac14.ijm}
    \item Modify this code to keep only the first time point.
    \end{itemize}
  \end{example}
\end{frame}

\section{User interaction}
\begin{frame}[fragile]
  \frametitle<presentation>{User Interaction (1/3)}
  \begin{itemize}
  \item The simplest way to request information from a user is to use
    the functions \code{getString()}, \code{getNumber()},
    \code{getDirectory()} and \code{File.openDialog()}.\par
    \lstinputlisting[firstline=3]{macros/mac15.ijm}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle<presentation>{User Interaction (2/3)}
  \begin{itemize}
  \item To have all parameters on a single user interface we can
    call \code{Dialog.create("title'');}, adding to it several elements
    using \code{Dialog.add\dots}, display it using
    \code{Dialog.show();} and finally get the values using
    \code{Dialog.get\dots} in the matching order.\par
    \lstinputlisting[firstline=3]{macros/mac16.ijm}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle<presentation>{User Interaction (3/3)}
  \begin{itemize}
  \item A very simple way to ask for parameters is to use annotations
    using the \code{\#@} symbol in the first lines of the file.\par
    \lstinputlisting{macros/mac17.ijm}

  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle<presentation>{User interaction}
  \begin{itemize}
  \item You can ask the user to perform a task and wait that this task is
    completed by using the built-in macro command \code{waitForUser(string)}:
    \lstinputlisting[firstline=3]{macros/mac18.ijm}
  \item It is often recommended to separate the user interaction from
    the actual processing.
  \end{itemize}
\end{frame}

\section{Images \& Windows}
%\begin{frame}
%  \frametitle{Images \& Windows}
%  \begin{itemize}
%  \item \code{newImage(title, type, width, height, depth)} creates a new
%    image. Where the type can be "8-bit", "16-bit", "32-bit" or
%    "RGB". It can also contain the parameters “white", "black" or
%    "ramp" as a filling value.
%  \item During the execution of a macro you can \code{setBatchMode(true)} to
%    hide the images during the processing. The execution is then up to
%    20 times faster. \code{setBatchMode(false)} at the end of the script
%    displays the active image and deletes the other ones.
%  \end{itemize}
%\end{frame}

\begin{frame}
  \frametitle{Images \& Windows}
  \begin{itemize}
  \item To identify a image/window you can use its identifier using
    \code{getImageID()} or its title with \code{getTitle()}.
  \item You can later set the focus on this image/window using
    \code{selectImage(id)} or \code{selectWindow(name)}.
  \item \code{nImages()} returns the number of opened images.
  \item There is no list of opened images and IDs are negative
    integers (hard to loop over images).
  \item \code{rename(string)} renames a window (eg to set an informative name
    to the image generated by a macro).
  \item \code{run("Duplicate...", string);} with string being an informative
    name, you would probably reduce the need of renaming images.
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \begin{example}[Using image identifier]~\par
	    \begin{itemize}
		    \item Modify the macro mac2.ijm using \code{getImageID()}.
		    \item Make a function that takes as an arugment the image id, sigma and threshold and test it on Zeiss1328.lsm.
		    \end{itemize}
	    \lstinputlisting[firstline=1]{macros/mac19.ijm}
	  \end{example}
\end{frame}

\section{File \& Directories}
Reference information on files is located
\href{http://rsb.info.nih.gov/ij/developer/macro/functions.html#file}{here}.
\begin{frame}
  \frametitle<presentation>{File \& Directories}
  \begin{itemize}
  \item \code{open(path)} opens an image, a ROI or a text file.
  \item \code{list = getFileList(myDir);} returns an array of
    filenames (strings) located in the folder myDir.
  \item There exist a set of tools performing
    simple batch processing in the \menu{Process > Batch}. You can write a script for an image and apply it to a set of files in given a folder.
  \item To handle both MS Windows and Mac OS/Unix path names, use
    \code{path = folder\_name + File.separator + filename;}.
     \item During the execution of a macro you can \code{setBatchMode(true)} to hide the images during the processing. The execution is then up to
    20 times faster. \code{setBatchMode(false)} at the end of the script
    displays the active image and deletes the other ones.
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
	\begin{example}[Adding parameters]~\par
		\begin{itemize}
			\item Modify mac19.ijm to add user input of the file directory, sigma, threshold.
		\end{itemize}
		\lstinputlisting{macros/mac20.ijm}
	\end{example}
\end{frame}

\begin{frame}
  \begin{example}[Folder batch processing]~\par
    \begin{itemize}
    \item To reproduce the \menu{Process > Batch \dots} functionnality.
      \lstinputlisting[firstline=3]{macros/mac21.ijm}
     \item How can we change the code we have so far to now batch process all the images that have lsm extension in the data folder? 
    \end{itemize}
  \end{example}
\end{frame}

\begin{frame}
	\begin{example}[Folder batch processing]~\par
		\begin{itemize}
			\item Use the idea in mac21.ijm to batch process the files in our data folder and modify mac20.ijm.
			\item The code can changed to only process the lsm files, \code{setBatchMode(true)} to hide processing in the background, close the ROI manager at the end of the processing of each file, customize the measurement and add the file name into the resulting table, etc.
			\lstinputlisting[firstline=1]{macros/mac20_batch.ijm}
		\end{itemize}
	\end{example}
\end{frame}

\begin{frame}
  \frametitle<presentation>{Bio-format}
  \begin{itemize}
  \item To open images using BioFormat you can make use of the
    BioFormat Macro extension. You may call the plugin to have
    informations on these extensions.
  \item<article> References on the bio-format extention is
    \href{https://www.openmicroscopy.org/site/support/bio-formats5.1/users/imagej/}{here}.
  \end{itemize}
\end{frame}

\begin{frame}
  \begin{example}[Using Bioformat]~\par
    \begin{itemize}
    \item This macro prints very basic metadata and open series (note the s+1).
      \lstinputlisting[firstline=3]{macros/mac22.ijm}
    \end{itemize}
  \end{example}
\end{frame}

\section{Stack \& Hyper-stacks}
\begin{frame}[fragile]
  \frametitle<presentation>{Stacks}
  \begin{itemize}
  \item Indices for z (slices), c (channels) and t (frames) start at \kw{1}.
  \item \code{N = nSlices();} returns the total number of planes.
  \item \code{setSlice(n);} sets the cursor at slice \code{n}.
  \item A loop on Z-planes is then:\par
    \lstinputlisting[firstline=3]{macros/mac23.ijm}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle<presentation>{Hyper-stacks}
  \begin{itemize}
  \item The 5D-dimensions of an hyper-stack can be determined using:
    \code{getDimensions(width, height, channels, slices, frames);}. It
    will assigns the variables width .. frames to the corresponding
    values.
  \item Use \code{Stack.setChannel(c)}, \code{Stack.setSlice(z)},
    \code{Stack.setFrame(t)} or directly
    \code{Stack.setPosition(c,z,t);} to set the position in the
    hyper-stack.
  \end{itemize}
\end{frame}

%\section{Overlays}
%You will find references on overlays
%\href{http://rsb.info.nih.gov/ij/developer/macro/functions.html#Overlay}{here}.
%\begin{frame} \frametitle<presentation>{Overlays}
%  \begin{itemize}
%  \item Non destructive overlays allows to add annotations on the
%    image.
%  \item They can be saved in the TIFF file or exported (Flatten) in
%    RGB jpg or PNG.
%  \item Basic drawing functions are
%    \begin{itemize}
%    \item \code{Overlay.drawLine(x0, y0, x1, y1);} to draw a line
%    \item \code{Overlay.drawEllipse(x0, y0, x1, y1);} to draw an ellipse
%    \item \code{Overlay.drawString(text, x,y);} to draw some text
%    \end{itemize}
%  \item \only<article>{You can use}\code{ run("Add Selection...",
%      "stroke=red width=2");}\only<article>{to} converts a selection
%    to an overlay.
%  \item Before adding overlays, one can clear the current overlays
%    using \code{Overlay.remove;}.
%  \item Once the overlay are drawn they might not be visible as one
%    need to refresh the display using \code{Overlay.show();}
%  \item When the image is a stack, one can specify the position of the
%    overlay using \code{Overlay.setPosition(i);}
%  \end{itemize}
%\end{frame}
%
%\begin{frame}[fragile]
%  \begin{example}[Add a scale bar and timer]~\par
%    \begin{itemize}
%    \item In this example, we want to add a timer and a scale bar to
%      all frames of the image stack (You may want to use \code{getVoxelSize(width, height, depth, unit)} and \code{Stack.getFrameInterval()} to get the pixel size and time interval).
%       \only<presentation>{\lstinputlisting[lastline=18]{macros/mac27.ijm}}
%       \only<article>{\lstinputlisting{macros/mac27.ijm}}
%    \end{itemize}
%  \end{example}
%\end{frame}
%
%
%\section{Calling another macro}
%
%\begin{frame}
%  \frametitle<presentation>{Calling another macro}
%  \begin{itemize}
%  \item To call another macro we can use \code{runMacro(name, arguments)}
%  \only<article>{\lstinputlisting{macros/mac28.ijm}}
%  \item Arguments is a string that fill be retreived by \code{getArguments()}, that
%    we need to parse manually.
%  \item Here is a generic way to perform this whilst having script parameters:
%  \only<article>{\lstinputlisting{macros/mac29.ijm}}
%  \only<presentation>{\lstinputlisting[firstline=7]{macros/mac29.ijm}}
%\end{itemize}
%\end{frame}

%\section{Tables}
%\begin{frame}[fragile]
%  \frametitle<presentation>{Table}
%  \begin{itemize}
%  \item The result table can get populated by error.
%  \item You might need more than one table to store the results.
%  \end{itemize}
%  \only<article>{\lstinputlisting{macros/mac30.ijm}}
%  \only<presentation>{\lstinputlisting[firstline=19,lastline=42]{macros/mac30.ijm}}
%\end{frame}


\only<article>{
  \section{Examples}

  % \subsection{Cell velocity}
  % This example relies on many of the previous example encountered
  % along this short tutorial. It aims at segmenting a single cell
  % moving across the field of view and measuring its speed.\par

  % \lstinputlisting{macros/Track_Cell.ijm}

  % One possible extention to this example would be to compute the mean
  % squared displacement $<d^2(t)>$ from the track and estimate the
  % persistence time $P$ using the F\"urth formula in 2D given by:
  % $$<d^2(\tau)> = 4D \left(\tau-P\left(1-e^{-\tau/P}\right)\right)$$
  % where $t$ is the lag-time and $D$ the diffusion coefficient. The
  % mean squared displacement is computed from the averaged squared
  % distance of between point located at time $t$ and and $t+\tau$ for
  % all time point $t$.

%   \subsection{Deconvolution}
%   In this example, we implement the Gold deconvolution algorithm. It
%   is an iterative algorithm which at each iteration $k$ from an input
%   image $f$ estimates the deblured image $u_k$ as:
%   $$ u_k = u_{k-1} \cdot \frac{f}{h \ast u_{k-1}} $$
%   where $h \ast u_{k-1}$ represent the bluring of the image
%   $u_{k-1}$. The algorithm can be then decomposed as:
%   \begin{enumerate}
%   \item compute $h \ast u_{k-1}$ as a new image
%   \item divide $f$ by the result of the previous operation as a new image
%   \item multiply the previous estimtate by this ratio
%   \item close the ratio image
%   \item go to step 1
%   \end{enumerate}
%   In this example we also illustrate the \code{appendToFilename()}
%   function we have seen before. We can test this macro using a sample image such as \par
%  \lstinputlisting{macros/Gold_Deblur3D.ijm}

 \subsection{Parent - Child relationship}

 In this example, we count create two type of ROI in the ROI Manager. This could
 be the situation occuring after the segmentation of two independent channels.

 \begin{figure}[h]
   \begin{center}
     \begin{tikzpicture}[very thick]
       \draw[blue] (0,0) circle (1);
       \draw[blue] (3,1) circle (1.3);
       \draw[red!75!black] (.5,.5) circle (.1);
       \draw[red!75!black] (.5,.1) circle (.1);
       \draw[red!75!black] (.1,.2) circle (.1);
       \draw[red!75!black] (.75,2) circle (.1);
       \draw[red!75!black] (3,.5) circle (.1);
       \draw[red!75!black] (4,.5) circle (.1);
     \end{tikzpicture}
   \end{center}
 \end{figure}

We start by measuring some quantities for each smaller region and


 \lstinputlisting[firstline=15]{macros/ROI_Overlap.ijm}


 \subsection{ROIs distance}

 In this example, we want to compute the distance between each green
 region to the closest red region:

 \begin{figure}[h]
   \begin{center}
     \begin{tikzpicture}[very thick]
       \draw[blue] (0,0) circle (1);
       \draw[blue] (3,1) rectangle (1.3,2);
       \draw[red!75!black] (.5,.5) circle (.1);
       \draw[red!75!black] (.5,1.2) circle (.1);
       \draw[red!75!black] (-1.1,-1) circle (.1);
       \draw[red!75!black] (.75,2) circle (.1);
       \draw[red!75!black] (3,.5) circle (.1);
       \draw[red!75!black] (4,.5) circle (.1);
     \end{tikzpicture}
   \end{center}
 \end{figure}

 In order to achieve this, we compute a distance map from the set of
 red regions and compute the minimum value of this distance map in the
 green regions. Here we can reuse a large portion of the code for overlaps.

 \lstinputlisting[firstline=15,lastline=50]{macros/ROI_Distance.ijm}



% \subsection{Cell divisions}
% This example contains two macros for the analysis of an image sequence
% monitoring cell division.

% In the macro ``count'', we count the number of cell in file located in
% a folder. We then plot the number of cells versus the time and try to
% estimate a cell division time.

% In the macro ``Classify Cells'', the cells are classify according to
% some measurements. A threshold for each measurement is computed and
% the ROI of the cells satisfying all the criterion will be drawn in
% red.

% \lstinputlisting{macros/MitoQuant.ijm}

} % \only<article>
\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "handout"
%%% TeX-engine: "xetex"
%%% End:
